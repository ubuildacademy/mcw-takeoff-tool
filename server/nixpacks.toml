providers = ["node", "python"]

# Railway's python provider will auto-install requirements.txt
# Railway's node provider will auto-install npm packages and run build
# Both providers run automatically when package.json and requirements.txt are detected
# IMPORTANT: Ensure Railway service root directory is set to "server/" in Railway dashboard

# Install system libraries required for OpenCV and Tesseract
# These are installed after Node.js provider sets up npm
# Note: PDF processing now uses PyMuPDF (pure Python, no system dependencies)
# bash is needed for sharp package to build native bindings
# tesseract is required for OCR-based room detection
# IMPORTANT: Install Tesseract via apt-get instead of Nix to avoid GLIBC version conflicts
# Nix Tesseract packages require GLIBC 2.38, but Railway's base image has GLIBC 2.37
[phases.install]
nixPkgs = ["libGL", "glib", "libGLU", "pkg-config", "bash"]
cmds = [
  "apt-get update && apt-get install -y tesseract-ocr tesseract-ocr-eng && echo 'Tesseract installed via apt-get'"
]

# Build phase: Build TypeScript (keep it lean for faster deploys)
[phases.build]
cmds = [
  "echo 'Building TypeScript...'",
  "npm run build",
  "echo 'Build complete.'"
]

[variables]
# Add nix profile bin to PATH so nix packages are available
# nixpacks installs packages via nix-env which creates symlinks in the profile
# We need to ensure these are in PATH at both build time and runtime
# Note: nix-env creates symlinks in /nix/var/nix/profiles/default/bin
# Include /bin and /usr/bin early so bash/sh are available for npm install
PATH = "/usr/bin:/bin:/nix/var/nix/profiles/default/bin:/root/.nix-profile/bin:$PATH"
# Ensure SHELL is set so npm can find shell for native builds (sharp package)
SHELL = "/bin/bash"
# Python venv will be available at runtime via the python provider
PYTHONUNBUFFERED = "1"
# Set LD_LIBRARY_PATH so OpenCV can find libGL.so.1 and other shared libraries from nixpacks
# This includes common nix store locations where libGL and other libraries are installed
# Note: glib libraries will be found dynamically in the start command
LD_LIBRARY_PATH = "/nix/var/nix/profiles/default/lib:/root/.nix-profile/lib:/usr/lib:/usr/local/lib:$LD_LIBRARY_PATH"
# Enable Python-based titleblock extraction (bypasses AI for testing)
USE_PYTHON_TITLEBLOCK_EXTRACTION = "true"

[start]
# Find glib libraries at runtime and add to LD_LIBRARY_PATH
# This ensures OpenCV can load libgthread-2.0.so.0
# OCR/Tesseract enabled for text-first room detection
cmd = "GLIB_LIB=$(find /nix/store -name 'libgthread-2.0.so.0' 2>/dev/null | head -1 | xargs dirname 2>/dev/null || echo ''); if [ -n \"$GLIB_LIB\" ]; then export LD_LIBRARY_PATH=\"$GLIB_LIB:/nix/var/nix/profiles/default/lib:/root/.nix-profile/lib:/usr/lib:/usr/local/lib:$LD_LIBRARY_PATH\"; fi; npm start"

