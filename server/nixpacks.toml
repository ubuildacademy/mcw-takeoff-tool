providers = ["node", "python"]

# Railway's python provider will auto-install requirements.txt
# Railway's node provider will auto-install npm packages and run build
# Both providers run automatically when package.json and requirements.txt are detected
# IMPORTANT: Ensure Railway service root directory is set to "server/" in Railway dashboard

# Install system libraries required for OpenCV and PDF processing
# These are installed after Node.js provider sets up npm
# Note: ImageMagick requires Ghostscript for PDF support
[phases.install]
nixPkgs = ["libGL", "glib", "libGLU", "pkg-config", "imagemagick", "ghostscript"]

# Build phase: Verify Python packages are installed correctly
[phases.build]
cmds = [
  "echo 'Verifying Python packages installation...'",
  "if [ -f /opt/venv/bin/python3 ]; then /opt/venv/bin/python3 -m pip list | grep -i opencv || echo 'WARNING: opencv-python not found in pip list'; fi",
  "if [ -f /opt/venv/bin/python3 ]; then /opt/venv/bin/python3 -c 'import sys; print(sys.path)' || echo 'Could not check Python path'; fi"
]

[variables]
# Don't override PATH here - let Node.js and Python providers set up their own paths
# Python venv will be available at runtime via the python provider
PYTHONUNBUFFERED = "1"
# Set LD_LIBRARY_PATH so OpenCV can find libGL.so.1 and other shared libraries from nixpacks
# This includes common nix store locations where libGL and other libraries are installed
LD_LIBRARY_PATH = "/nix/var/nix/profiles/default/lib:/root/.nix-profile/lib:/usr/lib:/usr/local/lib:$LD_LIBRARY_PATH"

[start]
cmd = "npm start"

